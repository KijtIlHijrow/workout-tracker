<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Workout Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --success: #10b981;
  --danger: #ef4444;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-700: #374151;
  --gray-900: #111827;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 16px;
  line-height: 1.5;
  color: var(--gray-900);
  background: var(--gray-50);
  -webkit-font-smoothing: antialiased;
  padding-bottom: env(safe-area-inset-bottom);
}

.screen {
  min-height: 100vh;
  padding: 20px;
  padding-top: max(20px, env(safe-area-inset-top));
}

.hidden {
  display: none !important;
}

/* Headers */
h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
}

h2 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 16px;
}

/* Buttons */
.btn {
  display: block;
  width: 100%;
  padding: 16px;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:active {
  background: var(--primary-dark);
  transform: scale(0.98);
}

.btn-secondary {
  background: var(--gray-100);
  color: var(--gray-900);
}

.btn-secondary:active {
  background: var(--gray-200);
}

/* Inputs */
input {
  display: block;
  width: 100%;
  padding: 16px;
  font-size: 16px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  margin-bottom: 12px;
  -webkit-appearance: none;
}

input:focus {
  outline: none;
  border-color: var(--primary);
}

/* Lists */
.exercise-list {
  margin: 20px 0;
}

.exercise-item {
  background: white;
  padding: 20px;
  margin-bottom: 12px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.exercise-name {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 4px;
}

.exercise-last {
  font-size: 14px;
  color: var(--gray-700);
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 24px;
  border-radius: 16px;
  width: 100%;
  max-width: 400px;
}

.modal-header {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 20px;
}

/* Badge */
.badge {
  display: inline-block;
  padding: 8px 16px;
  background: var(--primary);
  color: white;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 20px;
}

/* Sync status */
.sync-status {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--success);
  z-index: 100;
}

.sync-status.pending {
  background: #f59e0b;
}

/* Navigation */
.nav-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid var(--gray-200);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  padding-bottom: env(safe-area-inset-bottom);
}

.nav-item {
  padding: 12px;
  text-align: center;
  font-size: 12px;
  cursor: pointer;
  border: none;
  background: none;
  color: var(--gray-700);
}

.nav-item.active {
  color: var(--primary);
  font-weight: 600;
}

.schedule-day {
  margin-bottom: 16px;
}

.schedule-day label {
  display: block;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--gray-700);
}

.loading {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-700);
}
  </style>
</head>
<body>
  <!-- Screens -->
  <div id="auth-screen" class="screen">
    <h1>Workout Tracker</h1>
    <p style="color: var(--gray-700); margin-bottom: 32px;">
      Track your sets with ease. Sign in to get started.
    </p>

    <input
      type="email"
      id="auth-email"
      placeholder="your@email.com"
      autocomplete="email"
    />

    <input
      type="password"
      id="auth-password"
      placeholder="Password (optional)"
      autocomplete="current-password"
    />

    <button class="btn btn-primary" onclick="handleAuth()">
      Sign In
    </button>

    <p style="font-size: 14px; color: var(--gray-700); text-align: center; margin-top: 8px;">
      Leave password empty for magic link
    </p>

    <div id="auth-message" style="margin-top: 16px; text-align: center;"></div>
  </div>

  <div id="onboarding-screen" class="screen hidden">
    <h1>Welcome!</h1>
    <p style="color: var(--gray-700); margin-bottom: 24px;">
      Let's set up your weekly workout schedule.
    </p>

    <div id="schedule-setup">
      <div class="schedule-day" data-day="1">
        <label>Monday</label>
        <input type="text" placeholder="e.g., Push" />
      </div>
      <div class="schedule-day" data-day="2">
        <label>Tuesday</label>
        <input type="text" placeholder="e.g., Pull" />
      </div>
      <div class="schedule-day" data-day="3">
        <label>Wednesday</label>
        <input type="text" placeholder="e.g., Legs" />
      </div>
      <div class="schedule-day" data-day="4">
        <label>Thursday</label>
        <input type="text" placeholder="e.g., Push" />
      </div>
      <div class="schedule-day" data-day="5">
        <label>Friday</label>
        <input type="text" placeholder="e.g., Pull" />
      </div>
      <div class="schedule-day" data-day="6">
        <label>Saturday</label>
        <input type="text" placeholder="e.g., Legs" />
      </div>
      <div class="schedule-day" data-day="0">
        <label>Sunday</label>
        <input type="text" placeholder="Rest day" />
      </div>
    </div>

    <button class="btn btn-primary" onclick="saveSchedule()" style="margin-top: 24px;">
      Continue
    </button>
  </div>

  <div id="main-screen" class="screen hidden">
    <div class="sync-status" id="sync-indicator"></div>

    <div id="today-header">
      <!-- Populated by JS -->
    </div>

    <div id="exercise-list" class="exercise-list">
      <!-- Populated by JS -->
    </div>

    <div class="nav-bar">
      <button class="nav-item active" onclick="showMainScreen()">
        Workout
      </button>
      <button class="nav-item" onclick="showScreen('exercises-screen'); renderExerciseManager();">
        Exercises
      </button>
      <button class="nav-item" onclick="showScreen('settings-screen'); renderSettings();">
        Settings
      </button>
    </div>
  </div>

  <div id="settings-screen" class="screen hidden">
    <h2>Settings</h2>

    <div id="schedule-editor">
      <!-- Populated by JS -->
    </div>

    <button class="btn btn-primary" onclick="updateSchedule()" style="margin-top: 24px;">
      Save Schedule
    </button>

    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--gray-200);">
      <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Password Login</h3>
      <div id="password-fields">
        <!-- Populated by JS -->
      </div>
      <button class="btn btn-primary" onclick="updatePassword()" style="margin-top: 12px;">
        Save Password
      </button>
    </div>

    <button class="btn btn-secondary" onclick="handleSignOut()" style="margin-top: 24px;">
      Sign Out
    </button>

    <div class="nav-bar">
      <button class="nav-item" onclick="showMainScreen()">
        Workout
      </button>
      <button class="nav-item" onclick="showScreen('exercises-screen'); renderExerciseManager();">
        Exercises
      </button>
      <button class="nav-item active">
        Settings
      </button>
    </div>
  </div>

  <div id="exercises-screen" class="screen hidden">
    <h2>Manage Exercises</h2>

    <div id="exercise-groups">
      <!-- Populated by JS -->
    </div>

    <div style="margin-top: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="font-size: 18px; margin: 0;">Add Exercise</h3>
        <a href="#" onclick="showModal('equipment-modal'); renderEquipmentList(); return false;" style="color: var(--primary); font-size: 14px; text-decoration: none;">
          Manage Equipment
        </a>
      </div>
      <input type="text" id="new-exercise-name" placeholder="Exercise name" />
      <select id="new-exercise-type" style="display: block; width: 100%; padding: 16px; font-size: 16px; border: 2px solid var(--gray-200); border-radius: 12px; margin-bottom: 12px;">
        <!-- Populated by JS -->
      </select>
      <div id="equipment-chips" style="margin-bottom: 12px;">
        <!-- Populated by JS -->
      </div>
      <button class="btn btn-primary" onclick="addExercise()">Add Exercise</button>
    </div>

    <div class="nav-bar">
      <button class="nav-item" onclick="showMainScreen()">
        Workout
      </button>
      <button class="nav-item active">
        Exercises
      </button>
      <button class="nav-item" onclick="showScreen('settings-screen'); renderSettings();">
        Settings
      </button>
    </div>
  </div>

  <div id="history-screen" class="screen hidden">
    <!-- Workout history -->
  </div>

  <div id="equipment-modal" class="modal hidden" onclick="if(event.target === this) hideModal('equipment-modal')">
    <div class="modal-content">
      <div class="modal-header">Manage Equipment</div>

      <input
        type="text"
        id="new-equipment-name"
        placeholder="Equipment name (e.g., Barbell)"
        style="margin-bottom: 16px;"
      />
      <button class="btn btn-primary" onclick="addEquipment()" style="margin-bottom: 24px;">
        Add Equipment
      </button>

      <div id="equipment-list" style="max-height: 300px; overflow-y: auto;">
        <!-- Populated by JS -->
      </div>

      <button class="btn btn-secondary" onclick="hideModal('equipment-modal')" style="margin-top: 16px;">
        Close
      </button>
    </div>
  </div>

  <!-- Modals -->
  <div id="log-set-modal" class="modal hidden" onclick="if(event.target === this) hideModal('log-set-modal')">
    <div class="modal-content">
      <div class="modal-header" id="modal-exercise-name"></div>

      <label style="display: block; font-weight: 600; margin-bottom: 4px;">Weight (kg)</label>
      <input
        type="number"
        id="set-weight"
        inputmode="decimal"
        step="0.5"
        placeholder="0"
        autofocus
      />

      <label style="display: block; font-weight: 600; margin-bottom: 4px;">Reps</label>
      <input
        type="number"
        id="set-reps"
        inputmode="numeric"
        placeholder="0"
      />

      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="hideModal('log-set-modal')">
          Cancel
        </button>
        <button class="btn btn-primary" onclick="saveSet()">
          Log Set
        </button>
      </div>
    </div>
  </div>

  <script>
    // Configuration - REPLACE WITH YOUR SUPABASE CREDENTIALS
    const SUPABASE_URL = 'https://kmaupreezihgsodijhsm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttYXVwcmVlemloZ3NvZGlqaHNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTMzMjMsImV4cCI6MjA4NDM4OTMyM30.6BPqch4wh7hkFhNTlRXLCOUgpEOsYxNvRGVpIfD9gTU';

    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    const state = {
      user: null,
      exercises: [],
      schedule: [],
      equipment: [],
      syncQueue: [],
      lastStats: {},
      maxWeights: {}
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        state.user = session.user;
        await initializeApp();
      } else {
        showScreen('auth-screen');
      }

      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
          state.user = session.user;
          initializeApp();
        } else if (event === 'SIGNED_OUT') {
          state.user = null;
          showScreen('auth-screen');
        }
      });
    });

    // Screen navigation
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
    }

    // Show/hide modal
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    async function handleAuth() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const messageEl = document.getElementById('auth-message');

      if (!email) {
        messageEl.innerHTML = '<span style="color: var(--danger);">Please enter your email</span>';
        return;
      }

      if (password) {
        // Password login
        messageEl.innerHTML = '<span style="color: var(--gray-700);">Signing in...</span>';

        const { error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          messageEl.innerHTML = `<span style="color: var(--danger);">${escapeHtml(error.message)} <a href="#" onclick="document.getElementById('auth-password').value=''; handleAuth(); return false;" style="color: var(--primary);">Send magic link instead?</a></span>`;
        }
      } else {
        // Magic link
        messageEl.innerHTML = '<span style="color: var(--gray-700);">Sending magic link...</span>';

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.href
          }
        });

        if (error) {
          messageEl.innerHTML = `<span style="color: var(--danger);">${escapeHtml(error.message)}</span>`;
        } else {
          messageEl.innerHTML = '<span style="color: var(--success);">Check your email for the magic link!</span>';
        }
      }
    }

    async function initializeApp() {
      // Check if user has schedule
      const { data: schedule } = await supabase
        .from('workout_schedule')
        .select('*')
        .eq('user_id', state.user.id);

      if (!schedule || schedule.length === 0) {
        showScreen('onboarding-screen');
      } else {
        state.schedule = schedule;
        await loadExercises();
        await loadEquipment();
        await loadLastStats();
        await loadMaxWeights();
        loadSyncQueue();
        showMainScreen();
      }
    }

    async function saveSchedule() {
      const days = document.querySelectorAll('.schedule-day');
      const scheduleData = [];

      days.forEach(day => {
        const dayNum = parseInt(day.dataset.day);
        const input = day.querySelector('input');
        const workoutType = input.value.trim();

        if (workoutType) {
          scheduleData.push({
            user_id: state.user.id,
            day_of_week: dayNum,
            workout_type: workoutType
          });
        }
      });

      if (scheduleData.length === 0) {
        alert('Please add at least one workout day');
        return;
      }

      const { error } = await supabase
        .from('workout_schedule')
        .insert(scheduleData);

      if (error) {
        alert('Error saving schedule: ' + error.message);
        return;
      }

      state.schedule = scheduleData;
      showScreen('exercises-screen');
      renderExerciseManager();
    }

    async function loadExercises() {
      // Try localStorage first
      const cached = localStorage.getItem('exercises');
      if (cached) {
        state.exercises = JSON.parse(cached);
      }

      // Fetch fresh from Supabase
      const { data: exercises, error } = await supabase
        .from('exercises')
        .select('*')
        .eq('user_id', state.user.id)
        .order('name');

      if (!error && exercises) {
        // Handle empty exercises array
        if (exercises.length === 0) {
          state.exercises = [];
          localStorage.setItem('exercises', JSON.stringify([]));
          return;
        }

        // Fetch equipment links for all exercises
        const { data: links, error: linksError } = await supabase
          .from('exercise_equipment')
          .select('exercise_id, equipment_id')
          .in('exercise_id', exercises.map(ex => ex.id));

        if (linksError) {
          console.error('Error loading equipment links:', linksError);
        }

        // Group equipment IDs by exercise ID
        const equipmentByExercise = {};
        if (links) {
          links.forEach(link => {
            if (!equipmentByExercise[link.exercise_id]) {
              equipmentByExercise[link.exercise_id] = [];
            }
            equipmentByExercise[link.exercise_id].push(link.equipment_id);
          });
        }

        // Add equipment_ids to each exercise
        exercises.forEach(ex => {
          ex.equipment_ids = equipmentByExercise[ex.id] || [];
        });

        state.exercises = exercises;
        localStorage.setItem('exercises', JSON.stringify(exercises));
      }
    }

    async function loadEquipment() {
      // Try localStorage first
      const cached = localStorage.getItem('equipment');
      if (cached) {
        try {
          state.equipment = JSON.parse(cached);
        } catch (e) {
          console.error('Error parsing cached equipment:', e);
          localStorage.removeItem('equipment');
          state.equipment = [];
        }
      }

      // Fetch fresh from Supabase
      const { data, error } = await supabase
        .from('equipment')
        .select('*')
        .eq('user_id', state.user.id)
        .order('name');

      if (!error && data) {
        state.equipment = data;
        localStorage.setItem('equipment', JSON.stringify(data));
      } else if (error) {
        console.error('Error loading equipment:', error);
      }
    }

    async function loadLastStats() {
      // Get last logged set for each exercise
      const { data } = await supabase
        .from('sets')
        .select('exercise_id, weight, reps, logged_at')
        .eq('user_id', state.user.id)
        .order('logged_at', { ascending: false });

      if (data) {
        const stats = {};
        data.forEach(set => {
          if (!stats[set.exercise_id]) {
            stats[set.exercise_id] = { weight: set.weight, reps: set.reps };
          }
        });
        state.lastStats = stats;
      }
    }

    async function loadMaxWeights() {
      // Get sets with 6+ reps, ordered by weight descending
      const { data } = await supabase
        .from('sets')
        .select('exercise_id, weight, reps')
        .eq('user_id', state.user.id)
        .gte('reps', 6)
        .order('weight', { ascending: false });

      if (data) {
        state.maxWeights = {};
        // Take the first (highest weight) occurrence per exercise
        data.forEach(set => {
          if (!state.maxWeights[set.exercise_id]) {
            state.maxWeights[set.exercise_id] = { weight: set.weight, reps: set.reps };
          }
        });
      }
    }

    function showMainScreen() {
      showScreen('main-screen');
      renderMainScreen();
    }

    function renderMainScreen() {
      const today = new Date().getDay(); // 0 = Sunday
      const todaySchedule = state.schedule.find(s => s.day_of_week === today);

      // Render header
      const headerEl = document.getElementById('today-header');
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      if (todaySchedule) {
        headerEl.innerHTML = `
          <div class="badge">${escapeHtml(todaySchedule.workout_type.toUpperCase())} - ${dayNames[today]}</div>
        `;
      } else {
        headerEl.innerHTML = `
          <div class="badge" style="background: var(--gray-700);">REST DAY - ${dayNames[today]}</div>
        `;
      }

      // Filter exercises for today
      const todayExercises = todaySchedule
        ? state.exercises.filter(ex => ex.workout_type === todaySchedule.workout_type)
        : [];

      // Render exercise list
      const listEl = document.getElementById('exercise-list');

      if (todayExercises.length === 0) {
        listEl.innerHTML = `
          <p style="text-align: center; color: var(--gray-700); margin-top: 40px;">
            ${todaySchedule ? 'No exercises yet. Add some in the Exercises tab.' : 'Enjoy your rest day!'}
          </p>
        `;
        return;
      }

      listEl.innerHTML = todayExercises.map(ex => {
        const last = state.lastStats[ex.id];
        const max = state.maxWeights[ex.id];
        return `
          <div class="exercise-item exercise-item-clickable" data-exercise-id="${ex.id}">
            <div class="exercise-name">${escapeHtml(ex.name)}</div>
            ${last || max ? `
              <div class="exercise-last">
                ${last ? `Last: ${last.weight}kg × ${last.reps}` : ''}
                ${last && max ? ` | ` : ''}
                ${max ? `Max: ${max.weight}kg (${max.reps})` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    let currentExerciseId = null;

    function openLogModal(exerciseId, exerciseName) {
      currentExerciseId = exerciseId;
      document.getElementById('modal-exercise-name').textContent = exerciseName;

      // Pre-fill with last values
      const last = state.lastStats[exerciseId];
      if (last) {
        document.getElementById('set-weight').value = last.weight;
        document.getElementById('set-reps').value = last.reps;
      } else {
        document.getElementById('set-weight').value = '';
        document.getElementById('set-reps').value = '';
      }

      showModal('log-set-modal');

      // Focus weight input after modal opens
      setTimeout(() => {
        document.getElementById('set-weight').focus();
      }, 100);
    }

    async function saveSet() {
      const weight = parseFloat(document.getElementById('set-weight').value);
      const reps = parseInt(document.getElementById('set-reps').value);

      if (!weight || weight <= 0 || !reps || reps <= 0) {
        alert('Please enter valid weight and reps');
        return;
      }

      const setData = {
        user_id: state.user.id,
        exercise_id: currentExerciseId,
        weight,
        reps,
        logged_at: new Date().toISOString()
      };

      // Optimistic update
      state.lastStats[currentExerciseId] = { weight, reps };

      // Update max weight if this set qualifies (6+ reps and beats current max)
      if (reps >= 6) {
        const currentMax = state.maxWeights[currentExerciseId]?.weight || 0;
        if (weight > currentMax) {
          state.maxWeights[currentExerciseId] = { weight, reps };
        }
      }

      updateSyncStatus('pending');

      hideModal('log-set-modal');
      renderMainScreen();

      // Save to Supabase
      const { error } = await supabase
        .from('sets')
        .insert(setData);

      if (error) {
        console.error('Error saving set:', error);
        // Add to sync queue for retry
        state.syncQueue.push({ type: 'set', data: setData });
        localStorage.setItem('syncQueue', JSON.stringify(state.syncQueue));
      } else {
        updateSyncStatus('synced');
      }
    }

    function updateSyncStatus(status) {
      const indicator = document.getElementById('sync-indicator');
      if (status === 'synced') {
        indicator.classList.remove('pending');
      } else {
        indicator.classList.add('pending');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderEquipmentChips() {
      const chipsEl = document.getElementById('equipment-chips');

      if (state.equipment.length === 0) {
        chipsEl.innerHTML = '';
        return;
      }

      chipsEl.innerHTML = `
        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">
          Equipment (optional)
        </label>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${state.equipment.map(eq => `
            <div
              data-equipment-id="${eq.id}"
              class="equipment-chip"
              style="padding: 8px 12px; background: var(--gray-100); color: var(--gray-700); border-radius: 16px; font-size: 14px; cursor: pointer; user-select: none;"
            >
              ${escapeHtml(eq.name)}
            </div>
          `).join('')}
        </div>
      `;
    }

    function toggleEquipmentChip(equipmentId) {
      const chip = document.querySelector(`[data-equipment-id="${equipmentId}"]`);
      if (!chip) return; // Guard against missing elements

      if (chip.classList.contains('selected')) {
        chip.classList.remove('selected');
        chip.style.background = 'var(--gray-100)';
        chip.style.color = 'var(--gray-700)';
      } else {
        chip.classList.add('selected');
        chip.style.background = 'var(--primary)';
        chip.style.color = 'white';
      }
    }

    function getEquipmentNames(equipmentIds) {
      if (!equipmentIds || equipmentIds.length === 0) return '';

      return equipmentIds
        .map(id => {
          const eq = state.equipment.find(e => e.id === id);
          return eq ? eq.name : null;
        })
        .filter(Boolean)
        .join(' • ');
    }

    function renderExerciseManager() {
      // Get unique workout types from schedule
      const workoutTypes = [...new Set(state.schedule.map(s => s.workout_type))];

      // Populate workout type select
      const selectEl = document.getElementById('new-exercise-type');
      selectEl.innerHTML = workoutTypes.map(type =>
        `<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`
      ).join('');

      // Group exercises by workout type
      const groupsEl = document.getElementById('exercise-groups');

      if (state.exercises.length === 0) {
        groupsEl.innerHTML = '<p style="color: var(--gray-700);">No exercises yet. Add your first one below!</p>';
        return;
      }

      const grouped = {};
      state.exercises.forEach(ex => {
        if (!grouped[ex.workout_type]) grouped[ex.workout_type] = [];
        grouped[ex.workout_type].push(ex);
      });

      groupsEl.innerHTML = Object.entries(grouped).map(([type, exercises]) => `
        <div style="margin-bottom: 24px;" data-workout-type="${escapeHtml(type)}">
          <h3 class="workout-type-header" style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
            <span style="transition: transform 0.2s; display: inline-block;" class="collapse-arrow">▶</span>
            ${escapeHtml(type)}
          </h3>
          <div class="exercise-group-content" style="display: none;">
          ${exercises.map(ex => {
            const equipmentText = getEquipmentNames(ex.equipment_ids);
            return `
            <div class="exercise-item" style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
              <div style="flex: 1; min-width: 0;" class="exercise-display" data-exercise-id="${ex.id}">
                <span style="display: block; font-weight: 600;">${escapeHtml(ex.name)}</span>
                ${equipmentText ? `<span style="display: block; font-size: 12px; color: var(--gray-700); margin-top: 4px;">${escapeHtml(equipmentText)}</span>` : ''}
              </div>
              <div style="flex: 1; min-width: 0; display: none;" class="exercise-edit" data-exercise-id="${ex.id}">
                <input
                  type="text"
                  class="edit-exercise-input"
                  value="${escapeHtml(ex.name)}"
                  style="padding: 12px; margin-bottom: 0; font-size: 15px; border-radius: 8px;"
                />
                ${state.equipment.length > 0 ? `
                  <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                    ${state.equipment.map(eq => {
                      const isSelected = ex.equipment_ids.includes(eq.id);
                      return `
                        <div
                          data-equipment-id="${eq.id}"
                          class="equipment-chip-edit ${isSelected ? 'selected' : ''}"
                          style="padding: 6px 10px; background: ${isSelected ? 'var(--primary)' : 'var(--gray-100)'}; color: ${isSelected ? 'white' : 'var(--gray-700)'}; border-radius: 12px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.15s;"
                        >
                          ${escapeHtml(eq.name)}
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : ''}
              </div>
              <div style="display: flex; gap: 8px; flex-shrink: 0;" class="exercise-actions" data-exercise-id="${ex.id}">
                <button
                  class="edit-exercise-btn"
                  data-exercise-id="${ex.id}"
                  style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  Edit
                </button>
                <button
                  class="delete-exercise-btn"
                  data-exercise-id="${ex.id}"
                  style="background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  Delete
                </button>
              </div>
              <div style="display: none; gap: 8px; flex-shrink: 0; margin-top: 2px;" class="exercise-edit-actions" data-exercise-id="${ex.id}">
                <button
                  class="save-exercise-btn"
                  data-exercise-id="${ex.id}"
                  data-current-name="${escapeHtml(ex.name)}"
                  style="background: var(--success); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  Save
                </button>
                <button
                  class="cancel-edit-btn"
                  data-exercise-id="${ex.id}"
                  style="background: var(--gray-700); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  Cancel
                </button>
              </div>
            </div>
          `;}).join('')}
          </div>
        </div>
      `).join('');

      renderEquipmentChips();
    }

    async function addExercise() {
      const name = document.getElementById('new-exercise-name').value.trim();
      const workoutType = document.getElementById('new-exercise-type').value;

      if (!name) {
        alert('Please enter exercise name');
        return;
      }

      // Get selected equipment IDs
      const selectedChips = document.querySelectorAll('.equipment-chip.selected');
      const equipmentIds = Array.from(selectedChips).map(chip => chip.dataset.equipmentId);

      // Create exercise
      const { data: exercise, error: exerciseError } = await supabase
        .from('exercises')
        .insert({
          user_id: state.user.id,
          name,
          workout_type: workoutType
        })
        .select()
        .single();

      if (exerciseError) {
        if (exerciseError.code === '23505') {
          alert('Exercise already exists');
        } else {
          alert('Error adding exercise: ' + exerciseError.message);
        }
        return;
      }

      // Link equipment
      if (equipmentIds.length > 0) {
        const equipmentLinks = equipmentIds.map(eqId => ({
          exercise_id: exercise.id,
          equipment_id: eqId
        }));

        const { error: linkError } = await supabase
          .from('exercise_equipment')
          .insert(equipmentLinks);

        if (linkError) {
          // Rollback: delete the exercise we just created
          await supabase.from('exercises').delete().eq('id', exercise.id);
          alert('Error linking equipment: ' + linkError.message);
          return;
        }
      }

      // Add equipment_ids to exercise for local display
      exercise.equipment_ids = equipmentIds;

      state.exercises.push(exercise);
      localStorage.setItem('exercises', JSON.stringify(state.exercises));
      document.getElementById('new-exercise-name').value = '';

      // Deselect all chips
      document.querySelectorAll('.equipment-chip.selected').forEach(chip => {
        chip.classList.remove('selected');
        chip.style.background = 'var(--gray-100)';
        chip.style.color = 'var(--gray-700)';
      });

      renderExerciseManager();
    }

    function startEditExercise(exerciseId) {
      document.querySelector(`.exercise-display[data-exercise-id="${exerciseId}"]`).style.display = 'none';
      document.querySelector(`.exercise-edit[data-exercise-id="${exerciseId}"]`).style.display = 'block';
      document.querySelector(`.exercise-actions[data-exercise-id="${exerciseId}"]`).style.display = 'none';
      document.querySelector(`.exercise-edit-actions[data-exercise-id="${exerciseId}"]`).style.display = 'flex';

      const input = document.querySelector(`.exercise-edit[data-exercise-id="${exerciseId}"] .edit-exercise-input`);
      input.focus();
      input.select();
    }

    function cancelEditExercise(exerciseId) {
      document.querySelector(`.exercise-display[data-exercise-id="${exerciseId}"]`).style.display = 'block';
      document.querySelector(`.exercise-edit[data-exercise-id="${exerciseId}"]`).style.display = 'none';
      document.querySelector(`.exercise-actions[data-exercise-id="${exerciseId}"]`).style.display = 'flex';
      document.querySelector(`.exercise-edit-actions[data-exercise-id="${exerciseId}"]`).style.display = 'none';
    }

    async function saveEditExercise(exerciseId, currentName) {
      const editDiv = document.querySelector(`.exercise-edit[data-exercise-id="${exerciseId}"]`);
      const input = editDiv.querySelector('.edit-exercise-input');
      const newName = input.value.trim();

      if (!newName) {
        alert('Exercise name cannot be empty');
        return;
      }

      // Get selected equipment
      const selectedChips = editDiv.querySelectorAll('.equipment-chip-edit.selected');
      const newEquipmentIds = Array.from(selectedChips).map(chip => chip.dataset.equipmentId);

      const exercise = state.exercises.find(ex => ex.id === exerciseId);
      const oldEquipmentIds = exercise ? exercise.equipment_ids : [];

      const nameChanged = newName !== currentName;
      const equipmentChanged = JSON.stringify(newEquipmentIds.sort()) !== JSON.stringify(oldEquipmentIds.sort());

      if (!nameChanged && !equipmentChanged) {
        cancelEditExercise(exerciseId);
        return;
      }

      // Update name if changed
      if (nameChanged) {
        const { error } = await supabase
          .from('exercises')
          .update({ name: newName })
          .eq('id', exerciseId);

        if (error) {
          if (error.code === '23505') {
            alert('An exercise with this name already exists');
          } else {
            alert('Error updating exercise: ' + error.message);
          }
          return;
        }
      }

      // Update equipment if changed
      if (equipmentChanged) {
        // Delete old links
        await supabase
          .from('exercise_equipment')
          .delete()
          .eq('exercise_id', exerciseId);

        // Insert new links
        if (newEquipmentIds.length > 0) {
          const links = newEquipmentIds.map(eqId => ({
            exercise_id: exerciseId,
            equipment_id: eqId
          }));

          const { error } = await supabase
            .from('exercise_equipment')
            .insert(links);

          if (error) {
            alert('Error updating equipment: ' + error.message);
            return;
          }
        }
      }

      // Update local state
      if (exercise) {
        exercise.name = newName;
        exercise.equipment_ids = newEquipmentIds;
        localStorage.setItem('exercises', JSON.stringify(state.exercises));
      }

      renderExerciseManager();
    }

    async function deleteExercise(exerciseId) {
      if (!confirm('Delete this exercise? This will also delete all logged sets.')) {
        return;
      }

      const { error } = await supabase
        .from('exercises')
        .delete()
        .eq('id', exerciseId);

      if (error) {
        alert('Error deleting exercise: ' + error.message);
        return;
      }

      state.exercises = state.exercises.filter(ex => ex.id !== exerciseId);
      localStorage.setItem('exercises', JSON.stringify(state.exercises));
      delete state.lastStats[exerciseId];
      renderExerciseManager();
    }

    function renderSettings() {
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const editorEl = document.getElementById('schedule-editor');

      editorEl.innerHTML = dayNames.map((dayName, dayNum) => {
        const existing = state.schedule.find(s => s.day_of_week === dayNum);
        return `
          <div class="schedule-day" data-day="${dayNum}">
            <label>${dayName}</label>
            <input type="text" placeholder="Rest day" value="${existing ? escapeHtml(existing.workout_type) : ''}" />
          </div>
        `;
      }).join('');

      // Render password fields
      const passwordFieldsEl = document.getElementById('password-fields');
      passwordFieldsEl.innerHTML = `
        <input type="password" id="new-password" placeholder="New password (min 8 chars)" style="margin-bottom: 12px;" />
        <input type="password" id="confirm-password" placeholder="Confirm password" />
      `;
    }

    async function updateSchedule() {
      // Delete existing schedule
      await supabase
        .from('workout_schedule')
        .delete()
        .eq('user_id', state.user.id);

      // Collect new schedule
      const days = document.querySelectorAll('#schedule-editor .schedule-day');
      const scheduleData = [];

      days.forEach(day => {
        const dayNum = parseInt(day.dataset.day);
        const input = day.querySelector('input');
        const workoutType = input.value.trim();

        if (workoutType) {
          scheduleData.push({
            user_id: state.user.id,
            day_of_week: dayNum,
            workout_type: workoutType
          });
        }
      });

      if (scheduleData.length > 0) {
        const { error } = await supabase
          .from('workout_schedule')
          .insert(scheduleData);

        if (error) {
          alert('Error saving schedule: ' + error.message);
          return;
        }
      }

      state.schedule = scheduleData;
      alert('Schedule updated!');
      showMainScreen();
    }

    async function updatePassword() {
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!newPassword) {
        alert('Please enter a password');
        return;
      }

      if (newPassword.length < 8) {
        alert('Password must be at least 8 characters');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }

      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });

      if (error) {
        alert('Error setting password: ' + error.message);
        return;
      }

      alert('Password saved! You can now use it to sign in.');
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
    }

    async function handleSignOut() {
      if (!confirm('Sign out?')) return;

      await supabase.auth.signOut();
      state.user = null;
      state.exercises = [];
      state.schedule = [];
      state.equipment = [];
      state.lastStats = {};
      showScreen('auth-screen');
    }

    function renderEquipmentList() {
      const listEl = document.getElementById('equipment-list');

      if (state.equipment.length === 0) {
        listEl.innerHTML = '<p style="color: var(--gray-700); font-size: 14px;">No equipment yet. Add your first one above!</p>';
        return;
      }

      listEl.innerHTML = state.equipment.map(eq => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px;">
          <span>${escapeHtml(eq.name)}</span>
          <button
            class="delete-equipment-btn"
            data-equipment-id="${eq.id}"
            style="background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;"
          >
            Delete
          </button>
        </div>
      `).join('');
    }

    async function addEquipment() {
      const name = document.getElementById('new-equipment-name').value.trim();

      if (!name) {
        alert('Please enter equipment name');
        return;
      }

      const { data, error } = await supabase
        .from('equipment')
        .insert({
          user_id: state.user.id,
          name
        })
        .select()
        .single();

      if (error) {
        if (error.code === '23505') {
          alert('Equipment already exists');
        } else {
          alert('Error adding equipment: ' + error.message);
        }
        return;
      }

      state.equipment.push(data);
      state.equipment.sort((a, b) => a.name.localeCompare(b.name));
      localStorage.setItem('equipment', JSON.stringify(state.equipment));
      document.getElementById('new-equipment-name').value = '';
      renderEquipmentList();
    }

    async function deleteEquipment(equipmentId) {
      // Check usage count
      const { data: usageData } = await supabase
        .from('exercise_equipment')
        .select('exercise_id')
        .eq('equipment_id', equipmentId);

      const usageCount = usageData ? usageData.length : 0;

      const confirmMsg = usageCount > 0
        ? `Remove this equipment? Used by ${usageCount} exercise${usageCount > 1 ? 's' : ''}.`
        : 'Remove this equipment?';

      if (!confirm(confirmMsg)) {
        return;
      }

      const { error } = await supabase
        .from('equipment')
        .delete()
        .eq('id', equipmentId);

      if (error) {
        alert('Error deleting equipment: ' + error.message);
        return;
      }

      state.equipment = state.equipment.filter(eq => eq.id !== equipmentId);
      localStorage.setItem('equipment', JSON.stringify(state.equipment));
      renderEquipmentList();
    }

    // Load sync queue from localStorage
    function loadSyncQueue() {
      const queue = localStorage.getItem('syncQueue');
      if (queue) {
        state.syncQueue = JSON.parse(queue);
        if (state.syncQueue.length > 0) {
          processSyncQueue();
        }
      }
    }

    // Process pending sync queue
    async function processSyncQueue() {
      if (state.syncQueue.length === 0) {
        updateSyncStatus('synced');
        return;
      }

      updateSyncStatus('pending');

      const queue = [...state.syncQueue];
      const failed = [];

      for (const item of queue) {
        if (item.type === 'set') {
          const { error } = await supabase
            .from('sets')
            .insert(item.data);

          if (error) {
            failed.push(item);
          }
        }
      }

      state.syncQueue = failed;
      localStorage.setItem('syncQueue', JSON.stringify(failed));

      if (failed.length === 0) {
        updateSyncStatus('synced');
      }
    }

    // Retry sync on visibility change (app comes back to foreground)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && state.user) {
        processSyncQueue();
      }
    });

    // Enter key submits in modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !document.getElementById('log-set-modal').classList.contains('hidden')) {
        saveSet();
      }
    });

    // Tab order in modal
    document.getElementById('set-weight').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('set-reps').focus();
      }
    });

    // Enter key submits exercise, Esc clears text
    document.getElementById('new-exercise-name').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addExercise();
      } else if (e.key === 'Escape' && e.target.value) {
        e.preventDefault();
        e.target.value = '';
      }
    });

    // Enter key submits equipment, Esc clears
    document.getElementById('new-equipment-name').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addEquipment();
      } else if (e.key === 'Escape' && e.target.value) {
        e.preventDefault();
        e.target.value = '';
      }
    });

    // Keyboard shortcuts for exercise editing
    document.addEventListener('keydown', (e) => {
      if (e.target.classList.contains('edit-exercise-input')) {
        const editDiv = e.target.closest('.exercise-edit');
        if (!editDiv) return;

        const exerciseId = editDiv.dataset.exerciseId;

        if (e.key === 'Enter') {
          e.preventDefault();
          const saveBtn = document.querySelector(`.save-exercise-btn[data-exercise-id="${exerciseId}"]`);
          if (saveBtn) {
            saveEditExercise(exerciseId, saveBtn.dataset.currentName);
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEditExercise(exerciseId);
        }
      }
    });

    // Event delegation for all dynamic elements
    document.addEventListener('click', (e) => {
      // Workout type header collapse toggle
      const workoutHeader = e.target.closest('.workout-type-header');
      if (workoutHeader) {
        const container = workoutHeader.parentElement;
        const content = container.querySelector('.exercise-group-content');
        const arrow = workoutHeader.querySelector('.collapse-arrow');
        if (content.style.display === 'none') {
          content.style.display = 'block';
          arrow.style.transform = 'rotate(90deg)';
        } else {
          content.style.display = 'none';
          arrow.style.transform = 'rotate(0deg)';
        }
        return;
      }

      // Exercise item (workout view)
      const exerciseItem = e.target.closest('.exercise-item-clickable');
      if (exerciseItem) {
        const exerciseId = exerciseItem.dataset.exerciseId;
        const exercise = state.exercises.find(ex => ex.id === exerciseId);
        if (exercise) {
          openLogModal(exerciseId, exercise.name);
        }
        return;
      }

      // Equipment chip toggle (add exercise)
      const equipChip = e.target.closest('.equipment-chip');
      if (equipChip) {
        toggleEquipmentChip(equipChip.dataset.equipmentId);
        return;
      }

      // Equipment chip toggle (edit exercise)
      const equipChipEdit = e.target.closest('.equipment-chip-edit');
      if (equipChipEdit) {
        if (equipChipEdit.classList.contains('selected')) {
          equipChipEdit.classList.remove('selected');
          equipChipEdit.style.background = 'var(--gray-100)';
          equipChipEdit.style.color = 'var(--gray-700)';
        } else {
          equipChipEdit.classList.add('selected');
          equipChipEdit.style.background = 'var(--primary)';
          equipChipEdit.style.color = 'white';
        }
        return;
      }

      // Edit exercise button
      const editBtn = e.target.closest('.edit-exercise-btn');
      if (editBtn) {
        startEditExercise(editBtn.dataset.exerciseId);
        return;
      }

      // Save exercise button
      const saveBtn = e.target.closest('.save-exercise-btn');
      if (saveBtn) {
        saveEditExercise(saveBtn.dataset.exerciseId, saveBtn.dataset.currentName);
        return;
      }

      // Cancel edit button
      const cancelBtn = e.target.closest('.cancel-edit-btn');
      if (cancelBtn) {
        cancelEditExercise(cancelBtn.dataset.exerciseId);
        return;
      }

      // Delete exercise button
      const delExBtn = e.target.closest('.delete-exercise-btn');
      if (delExBtn) {
        deleteExercise(delExBtn.dataset.exerciseId);
        return;
      }

      // Delete equipment button
      const delEqBtn = e.target.closest('.delete-equipment-btn');
      if (delEqBtn) {
        deleteEquipment(delEqBtn.dataset.equipmentId);
        return;
      }
    });
  </script>
</body>
</html>
